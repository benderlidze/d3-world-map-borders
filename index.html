<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
    <style>
        body,
        html {
            margin: 0px;
            height: 0px;
        }

        div.tooltip {
            position: absolute;
            text-align: center;
            padding: 2px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
        }

        .highlight {
            fill: steelblue;
        }

        .hover {
            fill: rgb(255, 123, 0) !important;
        }

        .mouse-over {
            stroke: #333 !important;
            stroke-width: 2px !important;
        }

        #info {
            display: grid;
            grid-template-columns: auto auto auto auto;
            width: 100%;

        }

        .country-item {
            padding: 10px;
            cursor: pointer;
        }

        #map {
            height: 700px;
            border: 1px solid red;
        }
    </style>
</head>


<body>

    <div id="main">
        <div id="map"></div>
        <div id="info"></div>
    </div>

    <script>
        // const mainData = {
        //     selectedCountries: [],
        //     xlsxData: []
        // }
        let tempData = ''
        let selectedCountries = []

        const infoDiv = document.getElementById('info')
        createMap("map")

        var colorScheme = d3.schemeReds[6];
        colorScheme.unshift("#ccc")
        var colorScale = d3.scaleThreshold()
            .domain([0, 2, 4, 6, 8, 10])
            .range(colorScheme);

        // create a tooltip
        var tooltip = d3.select("#main")
            .append("div")
            .style("opacity", 0)
            .attr("class", "tooltip")
            .style("background-color", "white")
            .style("border", "solid")
            .style("border-width", "2px")
            .style("border-radius", "5px")
            .style("padding", "5px")

        var mouseover = function (d) {
            this.classList.add("mouse-over");
        }
        var mousemove = function (d, colummnId) {
            tooltip
                .html(`<strong>${d.properties.name}</strong><br>${d.val}`)
                .style("left", (d3.event.pageX + 10) + "px")
                .style("top", (d3.event.pageY + 10) + "px")
        }
        var mouseleave = function (d) {
            this.classList.remove("mouse-over");
        }

        function createMap(divId) {

            var svgDiv = document.getElementById(divId).getBoundingClientRect();
            let width = svgDiv.width;
            let height = svgDiv.height;

            const svg = d3.select("#" + divId)
                .append('svg')
                .attr("viewBox", `0 0 ${width} ${height}`)
                .attr("preserveAspectRatio", "xMidYMid meet");

            Promise.all([
                d3.json('https://enjalot.github.io/wwsd/data/world/world-110m.geojson'),
                d3.csv('https://docs.google.com/spreadsheets/d/e/2PACX-1vTo4paO9vSPtJA721ExKprmGACpXvCk3gmJlyIHel5OJVai9e3outQ6__I0fafyMY8Oxo6uJXgldWz9/pub?output=csv')
            ]).then(d => {
                buildMap(d[0])
                buildCountryList(d[1])
            });

            function buildMap(data) {
                data.features = data.features.filter(d => d.id !== "GRL" && d.id !== "ATA") //remove GRL and ATA from map 
                var projection = d3.geoMercator().fitSize([width, height], data);
                var path = d3.geoPath().projection(projection);
                const country = {};
                data.features.forEach(d => { d.val = country[d.id] });
                svg.append('g')
                    .attr('class', 'countries')
                    .selectAll('path')
                    .data(data.features)
                    .enter()
                    .append('path')
                    .attr('d', path)
                    .attr("class", "country")
                    .attr("id", d => d.properties.name.replaceAll(" ", "_"))
                    .style('fill', d => {
                        return "#FFF"
                    })
                    .style('stroke', 'black')
                    .style('opacity', 0.8)
                    .style('stroke-width', 0.3)
                    .on("mouseover", mouseover)
                    // .on("mousemove", (d) => mousemove(d, colummnId))
                    .on("mouseleave", mouseleave)
                    .on("click", (d) => {

                        console.log('d', d, tempData);
                        const country = d.properties.name
                        const link = tempData && selectedCountries.includes(country) ? `<div><a href="${tempData['More information']}" target="_blank">More information</a></div>` : ''
                        tooltip.style("opacity", 1)
                        tooltip
                            .html(`
                                <h3>${d.properties.name}</h3>
                                ${link}
                            `)
                            .style("left", (d3.event.pageX + 10) + "px")
                            .style("top", (d3.event.pageY + 10) + "px")
                    })
            }

            function buildCountryList(data) {
                console.log('data', data);
                data.map(item => {
                    const div = document.createElement('div')
                    div.innerText = item['Name of project']
                    div.setAttribute('class', 'country-item')
                    div.addEventListener('click', (e) => {

                        d3.selectAll(".hover").classed("hover", false);//remove previous selection
                        const countries = item['Country or countries'].split(',').map(d => d.trim())
                        tempData = item
                        selectedCountries = countries
                        console.log('countries', countries);
                        countries.map(country => {
                            d3.select("#" + country.replaceAll(" ", "_")).attr("class", "hover");
                        })
                    })
                    infoDiv.appendChild(div)
                })
            }
        }
    </script>
</body>

</html>